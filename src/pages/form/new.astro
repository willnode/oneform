---
import Layout from "../../layouts/Layout.astro";
import Control from "../../components/control/Control.astro";
import FormScript from "../../components/editor/FormScript.astro";
import editorSchema from "../../components/editor/schema";
import { unflatten } from "flat";
import { db, Form } from "astro:db";
import { getTeam } from "@components/model";
import { ulid } from "ulid";
import { backToLogin } from "@components/helper";

const team = await getTeam(Astro.request);
if (!team) {
  return backToLogin();
}

if (Astro.request.method === "POST") {
  const response = await Astro.request.formData();
  const values: any = unflatten(Object.fromEntries(response));
  const id = ulid();
  await db.insert(Form).values({
    ...values,
    id,
    teamId: team,
  });

  return new Response("", {
    status: 302,
    headers: {
      location: `/form/${id}/edit`,
    },
  });
}
---

<Layout title="Welcome to Astro.">
  <div class="container my-5" style="max-width: 800px;">
    <a class="select-none rounded-lg border border-gray-900 py-3 px-6 text-center align-middle font-sans text-xs font-bold uppercase text-gray-900 transition-all hover:opacity-75 focus:ring focus:ring-gray-300 active:opacity-[0.85] disabled:pointer-events-none disabled:opacity-50 disabled:shadow-none" href="/form">Back</a>
    <form id="form" name="form" method="post" class="my-5">
      <Control control={editorSchema} value={{}} />
      <button class="select-none rounded-lg bg-green-500 py-3 px-6 text-center align-middle font-sans text-xs font-bold uppercase text-white shadow-md shadow-green-500/20 transition-all hover:shadow-lg hover:shadow-green-500/40 focus:opacity-[0.85] focus:shadow-none active:opacity-[0.85] active:shadow-none disabled:pointer-events-none disabled:opacity-50 disabled:shadow-none">Create</button>
    </form>
  </div>
</Layout>

<FormScript />
