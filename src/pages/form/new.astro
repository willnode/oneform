---
import Layout from "../../layouts/Layout.astro";
import { unflatten } from "flat";
import { db, Form } from "astro:db";
import { ulid } from "ulid";
import { backToLogin } from "@/components/helper";
import NewForm from "./_new";
import { getTeam } from "@/lib/auth";

const team = await getTeam(Astro.request);
if (!team) {
  return backToLogin();
}

if (Astro.request.method === "POST") {
  const response = await Astro.request.formData();
  const values: any = unflatten(Object.fromEntries(response));
  const id = ulid();
  await db.insert(Form).values({
    ...values,
    id,
    teamId: team,
  });

  return new Response("", {
    status: 302,
    headers: {
      location: `/form/${id}/edit`,
    },
  });
}
---

<Layout title="New Form">
  <NewForm
    client:only="react"
    value={{
      title: "New Form",
      privilenge: "public",
      schema: [
        {
          id: ulid(),
          type: "text",
          variant: "single-line",
          code: "name",
          label: "Name",
          required: true,
        },
      ],
    }}
  />
</Layout>
