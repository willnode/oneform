---
import Layout from "@/layouts/Layout.astro";
import { backToLogin, notFound, asJson } from "@/components/helper";
import FormControl from "@/components/control/FormControl.tsx";
import editorSchema from "@/components/editor/schema";
import { unflatten } from "flat";
import { getTeam } from "@/components/model";
import FormNavbar from "@/components/editor/FormNavbar.tsx";
import * as query from "@/api/query";

const { form: formId } = Astro.params;

if (!formId) {
  return notFound();
}

const teamId = await getTeam(Astro.request);
if (!teamId) {
  return backToLogin();
}

const form = await query.getFormById(formId);
if (!form || form.teamId != teamId) {
  return notFound();
}

if (Astro.request.method === "POST") {
  const response = await Astro.request.formData();
  const values: any = unflatten(Object.fromEntries(response));
  delete values.id;
  delete values.teamId;
  return asJson(values);
  // await db
  //   .update(Form)
  //   .set({
  //     ...values,
  //   })
  //   .where(eq(Form.id, form.id));

  // return new Response("", {
  //   status: 302,
  //   headers: {
  //     location: `/form/${form.id}/edit`,
  //   },
  // });
}
---

<Layout title="Edit Form.">
  <FormNavbar page="edit" />
  <FormControl client:only="react" schema={editorSchema} value={form} />
  <button class="btn btn-lg btn-primary">Save</button>
</Layout>
