---
import { notFound } from "@/components/helper";
import fs from "node:fs/promises";
import { backTo } from "@/components/helper";
import query from "@/lib/query";

const { slug } = Astro.params;
const parts = (slug + "").split("/");

if (Astro.request.method !== "GET" || parts.length < 2 || parts[0] != "file") {
  return notFound();
}

const file = await query.getFileById(parts[1]);
if (!file) {
  return notFound();
}

if (parts.length === 2) {
  return backTo(`/upload/file/${parts[1]}/${file.name}`);
}

Astro.response.headers.append("Content-Type", file.type);
Astro.response.headers.append("Content-Length", file.size + "");

let fileb = await fs.readFile(file.path);

return new Response(fileb, {
  headers: {
    "Content-Type": file.type,
    "Content-Length": file.size + "",
  },
});
---
