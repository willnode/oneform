---
import { notFound } from "@/components/helper";
import fs from "node:fs/promises";
import { backTo } from "@/components/helper";
import query from "@/lib/query";

const { slug } = Astro.params;
const parts = (slug + "").split("/");

if (Astro.request.method !== "GET" || parts.length < 2 || parts[0] != "file") {
  return notFound();
}

const file = await query.getFileById(parts[1]);
if (!file) {
  return notFound();
}

if (parts.length === 2) {
  return backTo(`/upload/file/${parts[1]}/${file.name}`);
}

Astro.response.headers.append("Content-Type", file.type);
Astro.response.headers.append("Content-Length", file.size + "");
Astro.response.headers.append("Etag", file.etag);

let responseOptions = {
  headers: {
    "Access-Control-Allow-Origin": '*',
    "Cache-Control": 'max-age=3600',
    "Content-Type": file.type,
    "Content-Length": file.size + "",
    "Etag":  `W/"${file.etag}"`,
  },
};
let userEtag = Astro.request.headers.get("If-None-Match");
if (userEtag && userEtag === `W/"${file.etag}"`) {
  return new Response(null, {
    status: 304,
    ...responseOptions,
  });
}

let fileb = await fs.readFile(file.path);

return new Response(fileb, responseOptions);
---
