---
import { backToLogin, notFound } from "@/components/helper";
import query from "@/lib/query";
import Render from "./_view";
import Layout from "@/layouts/Layout.astro";

let path = Astro.url.pathname;
let subpath = "";

if (!path.endsWith("/")) {
  subpath = path.substring(path.lastIndexOf("/") + 1);
  path = path.substring(0, path.lastIndexOf("/") + 1);
}

let route = await query.getViewByRoute(path);
if (!route) {
  if (path === "/") {
    return backToLogin();
  }
  return new Response(path);
}
if (!route.schema) {
  return new Response("empty page here");
}

let schema =
  typeof route.schema === "string" ? JSON.parse(route.schema) : route.schema;
---

<Layout title={route.title}>
  <Render schema={schema} data={{ path, subpath }} />

  <script type="module" src="/component-client.js"></script>
</Layout>
